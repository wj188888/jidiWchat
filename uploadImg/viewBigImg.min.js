function previewImg(t,e){function i(){if(m.imgWidth>c.width()||m.imgHeight>c.height()){if(m.imgWidth>m.imgHeight){var t=Math.min(m.imgWidth+4,m.windowWidth-2*f),e=c.height();m.imgHeight>c.height()&&(e=Math.min(t*(m.imgHeight+4)/(m.imgWidth+4),m.windowHeight-2*f))}else{var e=Math.min(m.imgHeight+4,m.windowHeight-2*f),t=c.width();m.imgWidth>c.width()&&(t=Math.min(e*(m.imgWidth+4)/(m.imgHeight+4),m.windowWidth-2*f))}c.css({width:t,height:e})}else u.hide()}function a(){var t=/\((.+?)\)/g.exec(l.css("transform"));if(t){for(var e=t[1].split(","),i=0;i<e.length;i++)e[i]=Number(e[i]);return e}return[]}function n(){l.css({transform:"translate(-50%,-50%) rotate("+W+"deg) scale("+v+")",marginLeft:H.x,marginTop:H.y}),w=a()}function o(){var t=b?c.width():c.height(),e=b?c.height():c.width();formatImgInner(l,t,e)}function h(){b=W/90%2==0,o(),w=a(),v=w[0],v<1?u.show():u.hide(),n()}function r(){v<=.05?v=.05:v>=4&&(v=4),v>=1?u.hide():u.show(),n()}function g(){var t=b?m.imgWidth:m.imgHeight,e=b?m.imgHeight:m.imgWidth;if(parseInt(t*v)>c.width()){var i=(t*v-c.width())/2;x.x-i>H.x&&(H.x=x.x-i),x.x+i<H.x&&(H.x=x.x+i)}else S=!1,X=!1,H.x<-30?S=!0:H.x>30&&(X=!0);if(e*v>c.height()){var a=(e*v-c.height())/2;x.y-a>H.y&&(H.y=x.y-a),x.y+a<H.y&&(H.y=x.y+a)}else H.y=x.y;n()}function s(){opacityMask.empty().hide()}var c=$("<div class='bigImgWrap'>"),d=$("<div class='log_info'>"),l=$("<img src='"+t[e].attr("src")+"' style='display:none;'>"),u=$("<i class='f' title='缩放'>"),p=$("<i class='r' title='旋转'>");opacityMask.append(c.append(l)).show(),debug&&c.append(d);var m,f,w="",v=0,y=0,x={x:0,y:0},W=0,b=!0,H={x:0,y:0},k=!0,M=!1,I=0,P=[],O=[],A=[],L=0,R=0,E=[],U=0,Y=0,S=!1,X=!1;l.on("load",function(){l.show(),m={imgWidth:l.width(),imgHeight:l.height(),windowWidth:$(window).width(),windowHeight:$(window).height()},IsPC()?(c.css({width:615,height:415,transform:"translate(-50%,-50%)",boxShadow:"3px 3px 6px #cecece, -3px -3px 6px #cecece, 3px -3px 6px #cecece, -3px 3px 6px #cecece"}),f=10,c.append(u,p),i()):(c.css({borderWidth:0,top:0,left:0,right:0,bottom:-1}),opacityMask.css({backgroundColor:"black"}),f=0),formatImgInner(l,c.width(),c.height()),w=a(),v=w[0],1==v&&u.hide()}),opacityMask.on("click",function(){s()}),u.on("click",function(t){t.stopPropagation(),v=m.imgWidth/l.width(),r()}),p.on("click",function(t){t.stopPropagation(),W+=90,360==W&&(W=0),H={x:x.x,y:x.y},h()}),c.attr("tabindex",1).focus(),c.on("mousedown touchstart",function(t){t.preventDefault();var e="mousedown"==t.type?t:t.originalEvent.touches[0],i="mousedown"==t.type?t:t.originalEvent.touches[1];k=!0,M=!0,O={x:e.pageX,y:e.pageY},P={x:H.x,y:H.y},y=v,"touchstart"==t.type&&2==t.originalEvent.touches.length&&(A={x:i.pageX,y:i.pageY},L=getSpace(O.x,O.y,A.x,A.y),R=getAngle(O.x,O.y,A.x,A.y),I=W)}).on("mousemove touchmove",function(t){t.preventDefault();var e="mousemove"==t.type?t:t.originalEvent.touches[0],i="mousemove"==t.type?t:t.originalEvent.touches[1];if(E={x:e.pageX,y:e.pageY},M&&(Math.abs(E.y-O.y)>2||Math.abs(E.x-O.x)>2))if(k=!1,"mousemove"==e.type||1==t.originalEvent.touches.length){var a=(b?m.imgWidth:m.imgHeight,b?m.imgHeight:m.imgWidth);H.x=E.x-O.x+P.x,a*v>c.height()&&(H.y=E.y-O.y+P.y),g()}else 2==t.originalEvent.touches.length&&(U=getSpace(e.pageX,e.pageY,i.pageX,i.pageY),Y=getAngle(e.pageX,e.pageY,i.pageX,i.pageY),W=I+Y-R,v=U/L*y,r(),g())}).on("mouseup mouseout touchend",function(i){if(i.preventDefault(),M=!1,"touchend"==i.type){var a=b?m.imgWidth:m.imgHeight,o=b?m.imgHeight:m.imgWidth;a/o>c.width()/c.height()&&a*v<c.width()?v=c.width()/a:a/o<c.width()/c.height()&&o*v<c.height()&&(v=c.height()/o),W%90<30?W-=W%90:W+=90-W%90,b=W/90%2==0,l.css({transition:"0.5s"}),setTimeout(function(){l.css({transition:"0s"}),W<0&&(W+=360),W>360&&(W-=360)},500),H.x=0,n(),k&&s()}(S||X)&&(S?e>0?e-=1:e=t.length-1:X&&(e<t.length-1?e+=1:e=0),t.length>1&&(k=!0,$(this).click(),previewImg(t,e)))}).on("click",function(t){t.stopPropagation(),k&&s()}).on("mousewheel",function(t){t.preventDefault(),v-=t.originalEvent.deltaY/1e3,v=Number(v.toFixed(2)),r(),g()}).on("keydown",function(i){var a=i.keyCode;if(116!=a&&i.preventDefault(),37==a||38==a||39==a||40==a){switch(a){case 37:e>0?e-=1:e=t.length-1;break;case 38:e>0?e-=1:e=t.length-1;break;case 39:e<t.length-1?e+=1:e=0;break;case 40:e<t.length-1?e+=1:e=0}t.length>1&&(k=!0,c.click(),previewImg(t,e))}else 27==a&&c.click()})}function getFileBlob(t){var e=null;return void 0!=window.createObjectURL?e=window.createObjectURL(t):void 0!=window.URL?e=window.URL.createObjectURL(t):(window.navigator.userAgent.indexOf("Chrome")>=1||window.navigator.userAgent.indexOf("Safari")>=1)&&(e=window.webkitURL.createObjectURL(t)),e}function getImgBase64(t,e){var i=new FileReader;i.onload=function(t){e(t.target.result)},i.readAsDataURL(t)}function formatImgOuter(t,e,i){if(t[0].naturalWidth>t[0].naturalHeight)var a=i,n=a*t[0].naturalWidth/t[0].naturalHeight;else if(t[0].naturalWidth<t[0].naturalHeight)var n=e,a=n*t[0].naturalHeight/t[0].naturalWidth;else var n=e,a=i;t.css({width:n,height:a,transform:"translate(-50%,-50%)"})}function formatImgInner(t,e,i){if(t[0].naturalWidth>e||t[0].naturalHeight>i)if(t[0].naturalWidth/t[0].naturalHeight<e/i)var a=i/t[0].naturalHeight;else if(e<i)var a=e/t[0].naturalWidth;else var a=i/t[0].naturalHeight;else var a=1;t.css({transform:"translate(-50%,-50%) scale("+a+")"})}function IsPC(){for(var t=navigator.userAgent,e=new Array("Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"),i=!0,a=0;a<e.length;a++)if(t.indexOf(e[a])>0){i=!1;break}return i}function getAngle(t,e,i,a){var n=i-t,o=e-a,h=Math.sqrt(Math.pow(n,2)+Math.pow(o,2)),r=n/h,g=o/h,s=180/(Math.PI/Math.asin(r)),c=180/(Math.PI/Math.acos(g));if(s>0)var d=c;else var d=360-c;return parseInt(d)}function getSpace(t,e,i,a){var n=t-i,o=e-a,h=Math.sqrt(Math.pow(n,2)+Math.pow(o,2));return h}var debug=location.href.indexOf("http://localhost")!=-1,opacityMask=$("<div class='opacityMask'>").data("show",!1);$(function(){$("body").append(opacityMask)});